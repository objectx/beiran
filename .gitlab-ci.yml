stages:
 - test_image
 - lint
 - test
 - build

test_image:
 stage: test_image
 tags:
  - docker
 script:
  - docker login -u "gitlab-ci-token" -p "$CI_JOB_TOKEN" $CI_REGISTRY
  - docker pull $CI_REGISTRY_IMAGE:latest || true
  - ./make.sh push_test_image

lint:lib:
 stage: lint
 image: $CI_REGISTRY_IMAGE:latest
 tags:
  - docker
 script:
  - pylint beiran

lint:daemon:
 stage: lint
 image: $CI_REGISTRY_IMAGE:latest
 tags:
  - docker
 script:
  - pylint beirand/beirand

lint:cli:
 stage: lint
 image: $CI_REGISTRY_IMAGE:latest
 tags:
  - docker
 script:
  - pylint beiran-cli

test:
 stage: test
 tags:
  - docker
 script:
  - ./make.sh test_using_docker

build:daemon:
 stage: build
 tags:
  - docker
 script:
  - docker login -u "gitlab-ci-token" -p "$CI_JOB_TOKEN" $CI_REGISTRY
  - ./make.sh build_daemon_image
  - ./make.sh push_daemon_image
